<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kasir Jastip - Fashion Hunter</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel untuk JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
            overscroll-behavior: none;
            touch-action: manipulation;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f9fafb;
        }

        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 10px; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-in { animation: fadeIn 0.2s ease-out forwards; }
        
        @keyframes pulse-green {
            0% { box-shadow: 0 0 0 0 rgba(74, 222, 128, 0.7); }
            70% { box-shadow: 0 0 0 4px rgba(74, 222, 128, 0); }
            100% { box-shadow: 0 0 0 0 rgba(74, 222, 128, 0); }
        }
        .live-indicator { animation: pulse-green 2s infinite; }
    </style>
</head>
<body>
    <div id="root" class="w-full h-full flex justify-center"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect, useMemo, useCallback } = React;

        // --- ICONS ---
        const IconBase = ({ size = 20, className = "", children, ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{children}</svg>
        );
        const Smartphone = (p) => <IconBase {...p}><rect width="14" height="20" x="5" y="2" rx="2" ry="2"/><path d="M12 18h.01"/></IconBase>;
        const Globe = (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><path d="M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20"/><path d="M2 12h20"/></IconBase>;
        const Settings = (p) => <IconBase {...p}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></IconBase>;
        const CloudDownload = (p) => <IconBase {...p}><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/><path d="M12 12v9"/><path d="m8 17 4 4 4-4"/></IconBase>;
        const FileUp = (p) => <IconBase {...p}><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M12 12v6"/><path d="m15 15-3-3-3 3"/></IconBase>;
        const Eye = (p) => <IconBase {...p}><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></IconBase>;
        const User = (p) => <IconBase {...p}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></IconBase>;
        const Receipt = (p) => <IconBase {...p}><path d="M4 2v20l2-1 2 1 2-1 2 1 2-1 2 1 2-1 2 1V2l-2 1-2-1-2 1-2-1-2 1-2-1-2 1Z"/><path d="M16 8h-6"/><path d="M16 12h-6"/><path d="M10 16h6"/></IconBase>;
        const Plus = (p) => <IconBase {...p}><path d="M5 12h14"/><path d="M12 5v14"/></IconBase>;
        const CreditCard = (p) => <IconBase {...p}><rect width="20" height="14" x="2" y="5" rx="2"/><line x1="2" x2="22" y1="10" y2="10"/></IconBase>;
        const LayoutList = (p) => <IconBase {...p}><rect width="7" height="7" x="3" y="3" rx="1"/><rect width="7" height="7" x="3" y="14" rx="1"/><path d="M14 4h7"/><path d="M14 15h7"/></IconBase>;
        const ChevronRight = (p) => <IconBase {...p}><path d="m9 18 6-6-6-6"/></IconBase>;
        const Copy = (p) => <IconBase {...p}><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></IconBase>;
        const Send = (p) => <IconBase {...p}><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></IconBase>;
        const Trash2 = (p) => <IconBase {...p}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></IconBase>;
        const X = (p) => <IconBase {...p}><path d="M18 6 6 18"/><path d="m6 6 18 12"/></IconBase>;
        const RefreshCw = (p) => <IconBase {...p}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/></IconBase>;
        const Github = (p) => <IconBase {...p}><path d="M15 22v-4a4.8 4.8 0 0 0-1-3.5c3 0 6-2 6-5.5.08-1.25-.27-2.48-1-3.5.28-1.15.28-2.35 0-3.5 0 0-1 0-3 1.5-2.64-.5-5.36-.5-8 0C6 2 5 2 5 2c-.3 1.15-.3 2.35 0 3.5A5.403 5.403 0 0 0 4 9c0 3.5 3 5.5 6 5.5-.39.49-.68 1.05-.85 1.65-.17.6-.22 1.23-.15 1.85v4"/><path d="M9 18c-4.51 2-5-2-7-2"/></IconBase>;

        const App = () => {
            // --- 1. STATES ---
            const [activeTrip, setActiveTrip] = useState('china');
            const [databases, setDatabases] = useState({ china: [], malaysia: [], bkk: [] });
            const [tripTitle, setTripTitle] = useState("FASHION HUNTER JASTIP"); 
            const [customerName, setCustomerName] = useState("");
            const [items, setItems] = useState([]);
            const [dps, setDps] = useState([]);
            
            // Input states (as strings to handle comma typing)
            const [itemName, setItemName] = useState("");
            const [itemPrice, setItemPrice] = useState("");
            const [itemQty, setItemQty] = useState("1");
            const [dpInput, setDpInput] = useState("");
            
            // UI States
            const [showModal, setShowModal] = useState(false);
            const [showSettings, setShowSettings] = useState(false);
            const [showDataModal, setShowDataModal] = useState(false);
            const [isCopied, setIsCopied] = useState(false);
            const [isLoading, setIsLoading] = useState(false);
            const [foundCount, setFoundCount] = useState(0);
            const [showSuggestions, setShowSuggestions] = useState(false);
            
            // DEFAULT LINKS CONFIGURATION
            const defaultLinks = {
                china: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQqib3ZLcjWleprwKHZgpDYArhKoeKDWgZeW_VRm7Wm8xgx-XbARU0hOo62fWzUtjC3TIIEplSnZfb7/pub?output=csv",
                malaysia: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQvDU7G0mpNsE2jSrQ6nGhX6yTT2wzlhtkOzlWmAOdmklxV66DVf3kabzZ0cZIk85CPciPcHUAtLky2/pub?output=csv",
                bkk: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSc9iA6pX7X-GIz0XNZe34CLvAC7gAmnDe9y3E_moDpbDtmh45qYPe1vRc_Ezx20wwf6LDIin7Wro_c/pub?output=csv"
            };

            const [sheetLinks, setSheetLinks] = useState(defaultLinks);
            
            const fileInputRef = useRef(null);

            // --- 2. UTILS ---
            const pN = (v) => {
                if (typeof v === 'number') return v;
                if (!v) return 0;
                const normalized = v.toString().replace(/,/g, '.').replace(/[^\d.]/g, '');
                const parsed = parseFloat(normalized);
                return isNaN(parsed) ? 0 : parsed;
            };

            const formatR = (n) => {
                if (n === null || n === undefined || isNaN(n)) return "0";
                return new Intl.NumberFormat('id-ID', { maximumFractionDigits: 2 }).format(n);
            };

            const getFlag = (trip) => {
                const flags = { china: 'ðŸ‡¨ðŸ‡³', malaysia: 'ðŸ‡²ðŸ‡¾', bkk: 'ðŸ‡¹ðŸ‡­', manual: 'ðŸ“¦' };
                return flags[trip] || 'ðŸ³ï¸';
            };

            // --- 3. MEMOS ---
            const activeCsvData = useMemo(() => databases[activeTrip] || [], [databases, activeTrip]);
            const isAutoSyncActive = useMemo(() => !!(sheetLinks.china || sheetLinks.malaysia || sheetLinks.bkk), [sheetLinks]);

            const uniqueNames = useMemo(() => {
                const names = new Set();
                Object.values(databases).forEach(db => {
                    db.forEach(row => { if (row.nama && row.nama.trim() !== '') names.add(row.nama.trim()); });
                });
                return Array.from(names).sort();
            }, [databases]);

            const suggestions = useMemo(() => {
                if (!customerName) return [];
                return uniqueNames.filter(name => name.toLowerCase().includes(customerName.toLowerCase())).slice(0, 10);
            }, [customerName, uniqueNames]);

            // --- 4. DATA HANDLERS ---
            const processCSVData = useCallback((text, targetTrip) => {
                try {
                    const rows = text.split(/\r?\n/).filter(row => row.trim() !== '');
                    if (rows.length === 0) return;
                    const delimiter = rows[0].includes(';') ? ';' : ',';
                    const rawHeaders = rows[0].split(delimiter).map(h => h.trim().toLowerCase());
                    const keyMap = rawHeaders.map(h => {
                        if (h.includes('nam') || h.includes('cust')) return 'nama';
                        if (h.includes('qty') || h.includes('pcs')) return 'qty';
                        if (h.includes('var') || h.includes('warn')) return 'varian';
                        if (h.includes('bar') || h.includes('item')) return 'barang';
                        if (h.includes('har') || h.includes('pri') || h.includes('rp')) return 'harga';
                        return h; 
                    });
                    const parsedData = rows.slice(1).map(row => {
                        let values = [];
                        let currentVal = '';
                        let insideQuote = false;
                        for (let i = 0; i < row.length; i++) {
                            const char = row[i];
                            if (char === '"') insideQuote = !insideQuote;
                            else if (char === delimiter && !insideQuote) { values.push(currentVal.trim()); currentVal = ''; } 
                            else currentVal += char;
                        }
                        values.push(currentVal.trim());
                        const obj = {};
                        rawHeaders.forEach((_, i) => { obj[keyMap[i]] = values[i] || ""; });
                        if (obj.varian && obj.varian.trim() !== "" && obj.varian.trim() !== "-") {
                            obj.barang = obj.barang ? `${obj.barang} (${obj.varian.trim()})` : obj.varian.trim();
                        }
                        return obj;
                    });
                    setDatabases(prev => ({ ...prev, [targetTrip]: parsedData }));
                } catch (err) { console.error(err); }
            }, []);

            // --- 5. EFFECTS (AUTO REFRESH LOGIC) ---
            useEffect(() => {
                // 1. Load initial settings
                const savedLinks = localStorage.getItem('jastip_sheet_links');
                let linksObj = defaultLinks; // Use default links if nothing saved
                
                if (savedLinks) {
                    try { 
                        linksObj = JSON.parse(savedLinks);
                        setSheetLinks(linksObj); 
                    } catch(e) { }
                }

                // 2. Function for Silent Refresh
                const silentRefresh = async (currentLinks) => {
                    ['china', 'malaysia', 'bkk'].forEach(async (trip) => {
                        const url = currentLinks[trip];
                        if (url) {
                            try {
                                const response = await fetch(url);
                                if (response.ok) {
                                    const text = await response.text();
                                    processCSVData(text, trip);
                                }
                            } catch (e) { }
                        }
                    });
                };

                // 3. Refresh pertama kali aplikasi dibuka
                silentRefresh(linksObj);

                // 4. Set interval refresh setiap 2 menit (120.000 ms)
                const intervalId = setInterval(() => {
                    // Ambil links terbaru dari localStorage untuk memastikan data paling update
                    const latestLinks = JSON.parse(localStorage.getItem('jastip_sheet_links') || '{}');
                    silentRefresh(latestLinks);
                }, 120000);

                return () => clearInterval(intervalId);
            }, [processCSVData]);

            // Reset DP saat nama customer berubah (REVISI BARU)
            useEffect(() => {
                setDps([]);
            }, [customerName]);

            // Auto-detect items based on name
            useEffect(() => {
                const lowerName = customerName.trim().toLowerCase();
                if (!lowerName) {
                    setItems(prev => prev.filter(item => item.isManual));
                    setFoundCount(0);
                    return;
                }

                let allMatches = [];
                ['china', 'malaysia', 'bkk'].forEach(tripKey => {
                    const db = databases[tripKey] || [];
                    const matches = db.filter(row => row.nama && row.nama.toLowerCase().includes(lowerName));
                    matches.forEach(order => {
                        allMatches.push({
                            id: `auto-${tripKey}-${Math.random()}`,
                            name: order.barang || "Barang",
                            qty: pN(order.qty) || 1, 
                            price: pN(order.harga) || 0,
                            trip: tripKey,
                            isManual: false 
                        });
                    });
                });

                setFoundCount(allMatches.length);
                setItems(prevItems => {
                    const manualItems = prevItems.filter(item => item.isManual);
                    return [...manualItems, ...allMatches];
                });
            }, [customerName, databases]);

            // --- 6. EVENT HANDLERS ---
            const saveSettings = (newLinks) => {
                setSheetLinks(newLinks);
                localStorage.setItem('jastip_sheet_links', JSON.stringify(newLinks));
            };

            const handleSheetSync = async () => {
                const url = sheetLinks[activeTrip];
                if (!url) return setShowSettings(true);
                setIsLoading(true);
                try {
                    const response = await fetch(url);
                    const text = await response.text();
                    processCSVData(text, activeTrip);
                } catch (error) { console.error(error); }
                finally { setIsLoading(false); }
            };

            const addItem = (e) => {
                e.preventDefault();
                if (!itemName || !itemPrice) return;
                const newItem = { id: `manual-${Date.now()}`, name: itemName, qty: pN(itemQty), price: pN(itemPrice), trip: activeTrip, isManual: true };
                setItems([newItem, ...items]);
                setItemName(""); setItemPrice(""); setItemQty("1");
            };

            const updateItem = (id, field, value) => {
                setItems(items.map(it => it.id === id ? { ...it, [field]: pN(value) } : it));
            };

            const handleAddDp = (e) => {
                if (e) e.preventDefault();
                const val = pN(dpInput);
                if (val > 0) { setDps(prev => [...prev, { id: Date.now(), amount: val }]); setDpInput(""); }
            };

            const total = items.reduce((a, b) => a + (b.price * b.qty), 0);
            const totalDp = dps.reduce((a, b) => a + b.amount, 0);
            const sisa = total - totalDp;

            // --- WA FORMAT ---
            const getWA = () => {
                let t = `${tripTitle.toUpperCase()}\n`;
                t += `Customer: ${customerName || '-'}\n`;
                t += `------------------\n`; 
                
                const groups = { china: [], malaysia: [], bkk: [], manual: [] };
                items.forEach(it => { 
                    const key = it.trip || 'manual';
                    if (groups[key]) groups[key].push(it); else groups['manual'].push(it);
                });

                const printSec = (name, list, flag) => {
                    if (list.length === 0) return "";
                    let sec = `\nTRIP ${name} ${flag}\n`;
                    list.forEach((it, i) => {
                        const qtySuffix = it.qty !== 1 ? ` (${formatR(it.qty)}x)` : "";
                        sec += `${i + 1}. ${it.name}${qtySuffix} = ${formatR(it.price * it.qty)}\n`;
                    });
                    return sec;
                };

                t += printSec("CHINA", groups.china, "ðŸ‡¨ðŸ‡³");
                t += printSec("MALAYSIA", groups.malaysia, "ðŸ‡²ðŸ‡¾");
                t += printSec("BANGKOK", groups.bkk, "ðŸ‡¹ðŸ‡­");
                t += printSec("LAINNYA", groups.manual, "ðŸ“¦");

                t += `\n------------------\n`;
                t += `TOTAL TAGIHAN\n`;
                t += `Total Belanja: ${formatR(total)}\n`;
                if (totalDp > 0) t += `DP Masuk: ${formatR(totalDp)}\n`;
                
                t += `Sisa Pembayaran: ${sisa === 0 ? "LUNAS âœ…" : formatR(sisa)}\n`;

                t += `\nTerima kasih sudah berbelanja\n`;
                t += `Mohon dicek kembali ya kak`;
                return t;
            };

            const handleCopy = () => {
                const textArea = document.createElement("textarea");
                textArea.value = getWA();
                document.body.appendChild(textArea);
                textArea.select();
                try { document.execCommand('copy'); setIsCopied(true); setTimeout(() => setIsCopied(false), 2000); } catch (e) { }
                document.body.removeChild(textArea);
            };

            return (
                <div className="h-[100dvh] bg-gray-50 text-gray-900 font-sans w-full sm:max-w-md mx-auto flex flex-col relative overflow-hidden shadow-2xl border-x border-gray-200">
                
                {/* Header */}
                <header className="px-4 pt-4 pb-2 bg-white border-b border-gray-900 shrink-0">
                    <div className="flex flex-col gap-3">
                        <div className="flex justify-between items-center">
                            <span className="text-xs font-black uppercase tracking-widest text-gray-500 flex items-center gap-1">
                                <Smartphone size={14} /> Fashion Hunter
                            </span>
                            <div className="flex gap-1.5 items-center">
                                <button 
                                    onClick={() => activeCsvData.length > 0 && setShowDataModal(true)}
                                    className={`flex items-center gap-1.5 px-2 py-1.5 rounded border ${activeCsvData.length > 0 ? 'border-green-200 bg-green-50 text-green-700' : 'border-gray-200 bg-gray-50 text-gray-400'}`}
                                >
                                    <div className={`w-1.5 h-1.5 rounded-full ${isAutoSyncActive ? 'bg-green-500 live-indicator' : (activeCsvData.length > 0 ? 'bg-green-500' : 'bg-gray-300')}`}></div>
                                    <span className="text-[9px] font-bold">{activeCsvData.length}</span>
                                </button>
                                <button onClick={() => setShowSettings(true)} className="p-1.5 border border-gray-200 rounded hover:bg-gray-100"><Settings size={14} /></button>
                                <div className="bg-black text-white p-1.5 px-2 flex items-center gap-1 rounded-sm">
                                    <Globe size={12} />
                                    <span className="text-[9px] font-bold uppercase tracking-tight">{activeTrip}</span>
                                </div>
                            </div>
                        </div>

                        <div className="grid grid-cols-3 gap-2">
                            {['china', 'malaysia', 'bkk'].map(trip => (
                                <button key={trip} onClick={() => setActiveTrip(trip)} className={`text-[10px] font-black uppercase py-2 border border-black rounded-sm transition-all ${activeTrip === trip ? 'bg-black text-white' : 'bg-white hover:bg-gray-50'}`}>
                                    {getFlag(trip)} {trip}
                                </button>
                            ))}
                        </div>

                        <div className="flex gap-2 items-center">
                            <input value={tripTitle} onChange={(e) => setTripTitle(e.target.value)} className="font-bold text-sm outline-none flex-1 bg-transparent border-b border-transparent focus:border-black" placeholder="JUDUL NOTA..." />
                            <div className="flex gap-1">
                                <button onClick={handleSheetSync} className="border border-black p-2 rounded-sm bg-white hover:bg-gray-50">
                                    {isLoading ? <RefreshCw size={16} className="animate-spin"/> : <CloudDownload size={16} />}
                                </button>
                                <button onClick={() => fileInputRef.current?.click()} className="border border-black p-2 rounded-sm bg-white hover:bg-gray-50">
                                    <FileUp size={16} />
                                </button>
                            </div>
                            <input type="file" ref={fileInputRef} onChange={(e) => {
                                const file = e.target.files[0];
                                if (!file) return;
                                const reader = new FileReader();
                                reader.onload = (ev) => processCSVData(ev.target.result, activeTrip);
                                reader.readAsText(file);
                            }} accept=".csv" className="hidden" />
                        </div>
                    </div>
                </header>

                <main className="flex-1 p-4 overflow-y-auto bg-gray-50 pb-32 custom-scrollbar">
                    <div className="bg-white border border-black shadow-sm rounded-sm overflow-hidden animate-in">
                        
                        {/* Section 1: Customer */}
                        <div className="p-4 border-b border-gray-200 relative z-10">
                            <div className="flex justify-between items-center mb-2">
                                <p className="text-[10px] font-bold uppercase text-gray-500 flex items-center gap-2"><User size={12} /> Customer</p>
                                {customerName && <span className="text-[10px] font-bold px-2 py-0.5 rounded-full bg-blue-50 text-blue-700">{foundCount} Match</span>}
                            </div>
                            <div className="relative">
                                <input
                                    placeholder="Ketik nama customer..."
                                    value={customerName}
                                    onChange={(e) => { setCustomerName(e.target.value); setShowSuggestions(true); }}
                                    onFocus={() => setShowSuggestions(true)}
                                    onBlur={() => setTimeout(() => setShowSuggestions(false), 200)}
                                    autoComplete="off"
                                    className="w-full p-2 text-base border-b border-black focus:border-black outline-none font-bold"
                                />
                                {showSuggestions && customerName && suggestions.length > 0 && (
                                    <div className="absolute left-0 right-0 top-full mt-1 bg-white border-2 border-black max-h-48 overflow-y-auto z-50 rounded-sm shadow-lg">
                                        {suggestions.map((name, idx) => (
                                            <div key={idx} onMouseDown={() => { setCustomerName(name); setShowSuggestions(false); }} className="p-3 text-sm font-bold uppercase border-b border-gray-100 hover:bg-gray-100 cursor-pointer">{name}</div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* Section 2: Input Barang */}
                        <div className="p-4 border-b border-gray-200">
                            <p className="text-[10px] font-bold uppercase text-gray-500 mb-3 flex items-center gap-2"><Receipt size={12} /> Item Manual</p>
                            <form onSubmit={addItem} className="space-y-3">
                                <input placeholder="Nama barang..." value={itemName} onChange={(e) => setItemName(e.target.value)} className="w-full p-2 text-base border-b border-gray-300 outline-none font-medium focus:border-black" />
                                <div className="flex gap-3 items-end">
                                    <div className="flex-[2] relative border-b border-gray-300 focus-within:border-black">
                                        <span className="absolute left-0 top-1/2 -translate-y-1/2 text-gray-400 font-bold text-sm">Rp</span>
                                        <input placeholder="Harga" value={itemPrice} onChange={(e) => setItemPrice(e.target.value.replace(/[^0-9,]/g, ''))} className="w-full py-2 pl-6 text-base bg-transparent outline-none font-mono font-bold" inputMode="decimal" />
                                    </div>
                                    <div className="flex-1 border-b border-gray-300 focus-within:border-black">
                                        <input placeholder="Qty" value={itemQty} onChange={(e) => setItemQty(e.target.value.replace(/[^0-9,]/g, ''))} className="w-full py-2 text-base bg-transparent outline-none text-center font-bold" inputMode="decimal" />
                                    </div>
                                    <button type="submit" className="bg-black text-white p-2 rounded hover:bg-gray-800 transition-all"><Plus size={18} /></button>
                                </div>
                            </form>
                        </div>

                        {/* Section 3: Input DP */}
                        <div className="p-4 border-b border-gray-200">
                            <p className="text-[10px] font-bold uppercase text-gray-500 mb-3 flex items-center gap-2"><CreditCard size={12} /> Input DP</p>
                            <form onSubmit={handleAddDp} className="flex gap-3 items-end">
                                <div className="relative flex-1 border-b border-gray-300 focus-within:border-black">
                                    <span className="absolute left-0 top-1/2 -translate-y-1/2 text-gray-400 font-bold text-sm">Rp</span>
                                    <input placeholder="Nominal DP" value={dpInput} onChange={(e) => setDpInput(e.target.value.replace(/[^0-9,]/g, ''))} className="w-full py-2 pl-6 text-base bg-transparent outline-none font-bold text-right font-mono" inputMode="decimal" />
                                </div>
                                <button type="submit" className="px-4 py-1.5 bg-gray-200 text-black font-bold text-[10px] uppercase rounded hover:bg-gray-300">Add</button>
                            </form>
                        </div>

                        {/* Rincian Summary Trigger */}
                        <button onClick={() => setShowModal(true)} className="w-full p-4 flex justify-between items-center hover:bg-gray-50 border-b border-gray-200">
                            <div className="flex items-center gap-3">
                                <div className="bg-black text-white p-2 rounded-sm"><LayoutList size={16} /></div>
                                <div className="text-left">
                                    <p className="text-[10px] font-black uppercase tracking-widest">Rincian Belanja</p>
                                    <p className="text-[10px] text-gray-500 font-bold">{items.length} Item â€¢ {dps.length} DP Masuk</p>
                                </div>
                            </div>
                            <ChevronRight size={18} className="text-gray-400" />
                        </button>

                        {/* Bottom Total View */}
                        <div className="p-4 bg-gray-50 space-y-4">
                            <div className="flex justify-between items-center px-1">
                                <div className="flex flex-col"><span className="text-[10px] font-bold text-gray-400 uppercase">Total</span><span className="text-sm font-black">Rp {formatR(total)}</span></div>
                                <div className="flex flex-col text-right"><span className="text-[10px] font-bold text-gray-400 uppercase">DP</span><span className="text-sm font-black text-red-500">- Rp {formatR(totalDp)}</span></div>
                            </div>
                            <div className="mt-2 pt-3 border-t border-gray-200 flex justify-between items-center">
                                <span className="text-xs font-bold uppercase tracking-tight">{sisa >= 0 ? "Sisa Pembayaran" : "Uang Kembalian"}</span>
                                <span className={`text-xl font-black ${sisa === 0 ? 'text-green-600' : 'text-black'}`}>{sisa === 0 ? "LUNAS âœ…" : `Rp ${formatR(Math.abs(sisa))}`}</span>
                            </div>
                            <div className="grid grid-cols-2 gap-3">
                                <button onClick={handleCopy} className={`bg-white border-2 border-black py-2.5 rounded-lg font-black uppercase text-xs flex items-center justify-center gap-2 active:scale-95 transition-all ${isCopied ? 'bg-green-50 text-green-700 border-green-700' : ''}`}>
                                    <Copy size={16} /> {isCopied ? "Disalin!" : "Salin Nota"}
                                </button>
                                <button onClick={() => window.open(`https://wa.me/?text=${encodeURIComponent(getWA())}`)} className="bg-black text-white py-2.5 rounded-lg font-black uppercase text-xs flex items-center justify-center gap-2 active:scale-95 transition-all">
                                    <Send size={16} /> Kirim WA
                                </button>
                            </div>
                        </div>
                    </div>
                </main>

                {/* MODAL: RINCIAN BELANJA */}
                {showModal && (
                    <div className="fixed inset-0 bg-black/80 z-[60] flex items-center justify-center p-4 animate-in">
                        <div className="bg-white w-full max-w-md h-[85vh] flex flex-col border-2 border-black rounded shadow-2xl overflow-hidden">
                            <div className="flex justify-between items-center p-4 border-b-2 border-black bg-white shrink-0">
                                <h3 className="font-black text-xl uppercase italic tracking-tighter">Rincian Belanja</h3>
                                <button onClick={() => setShowModal(false)} className="p-2 border border-black rounded hover:bg-black hover:text-white"><X size={18}/></button>
                            </div>
                            
                            <div className="flex-1 overflow-y-auto p-4 space-y-6 custom-scrollbar bg-gray-50">
                                {/* SECTION: BARANG */}
                                <div className="space-y-3">
                                    <div className="flex items-center gap-2 border-b border-black pb-1">
                                        <Receipt size={14} className="text-gray-400" />
                                        <p className="text-[10px] font-black text-gray-400 uppercase tracking-widest">Daftar Barang ({items.length})</p>
                                    </div>
                                    <div className="grid gap-2">
                                        {items.length === 0 && <p className="text-xs text-center py-4 text-gray-400 italic">Belum ada barang...</p>}
                                        {items.map(it => (
                                            <div key={it.id} className="bg-white p-3 border border-black rounded flex flex-col gap-2 shadow-sm relative group animate-in">
                                                <div className="flex justify-between items-start">
                                                    <div className="flex items-center gap-1.5 min-w-0">
                                                        <span className="text-sm shrink-0">{getFlag(it.trip)}</span>
                                                        <span className="text-xs font-black uppercase truncate leading-tight">{it.name}</span>
                                                    </div>
                                                    <button onClick={() => setItems(items.filter(i=>i.id!==it.id))} className="text-gray-300 hover:text-red-500 transition-colors ml-2"><Trash2 size={16}/></button>
                                                </div>
                                                <div className="flex gap-2">
                                                    <div className="flex-1 relative">
                                                        <span className="absolute left-2 top-1/2 -translate-y-1/2 text-[10px] font-bold text-gray-300">Rp</span>
                                                        <input value={formatR(it.price)} onChange={(e) => updateItem(it.id, 'price', e.target.value)} className="w-full pl-6 pr-2 py-1 bg-gray-50 border border-gray-100 rounded text-[11px] font-mono font-bold focus:bg-white outline-none" />
                                                    </div>
                                                    <div className="w-14 relative">
                                                        <input value={it.qty.toString().replace(/\./g, ',')} onChange={(e) => updateItem(it.id, 'qty', e.target.value)} className="w-full py-1 bg-gray-50 border border-gray-100 rounded text-[11px] font-bold text-center focus:bg-white outline-none" />
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>

                                {/* SECTION: DP */}
                                <div className="space-y-3">
                                    <div className="flex items-center gap-2 border-b border-black pb-1">
                                        <CreditCard size={14} className="text-gray-400" />
                                        <p className="text-[10px] font-black text-gray-400 uppercase tracking-widest">Riwayat Pembayaran DP</p>
                                    </div>
                                    <div className="grid gap-2">
                                        {dps.length === 0 && <p className="text-xs text-center py-4 text-gray-400 italic">Belum ada DP...</p>}
                                        {dps.map((d, i) => (
                                            <div key={d.id} className="flex justify-between items-center bg-green-50 p-3 border border-green-200 rounded text-xs font-bold animate-in">
                                                <span className="text-green-800 uppercase tracking-tighter text-[9px]">DP Terbayar #{i+1}</span>
                                                <div className="flex items-center gap-3">
                                                    <span className="font-mono text-green-900">Rp {formatR(d.amount)}</span>
                                                    <button onClick={() => setDps(dps.filter(i=>i.id!==d.id))} className="text-green-300 hover:text-red-500 transition-colors"><X size={14}/></button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                            
                            <div className="p-4 bg-white border-t-2 border-black shrink-0">
                                <div className="flex justify-between items-center mb-4 px-1">
                                    <p className="text-[10px] font-black uppercase text-gray-400 tracking-widest">Total Sisa Tagihan</p>
                                    <p className="font-black text-xl italic">Rp {formatR(sisa)}</p>
                                </div>
                                <div className="grid grid-cols-2 gap-2">
                                   <button onClick={() => window.open(`https://wa.me/?text=${encodeURIComponent(getWA())}`)} className="bg-white border-2 border-black text-black py-3 font-black uppercase text-xs rounded-lg flex items-center justify-center gap-2 active:scale-95">
                                        <Send size={16} /> WA
                                    </button>
                                    <button onClick={() => setShowModal(false)} className="bg-black text-white py-3 font-black uppercase text-xs rounded-lg active:scale-95">
                                        Selesai
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                )}

                {/* MODAL: SETTINGS & CONFIG */}
                {showSettings && (
                    <div className="fixed inset-0 bg-black/80 z-[70] flex items-center justify-center p-4 animate-in">
                        <div className="bg-white w-full max-md h-[80vh] flex flex-col p-5 border-2 border-black rounded shadow-2xl overflow-y-auto custom-scrollbar">
                            <div className="flex justify-between items-center mb-5 border-b-2 border-black pb-3">
                                <h3 className="font-black text-lg uppercase italic">Configuration</h3>
                                <button onClick={() => setShowSettings(false)} className="p-1 border border-black rounded"><X size={18}/></button>
                            </div>
                            
                            <div className="space-y-6">
                                {/* Google Sheets CSV Link */}
                                <div className="space-y-3">
                                    <div className="flex justify-between items-center">
                                        <p className="font-black text-[10px] uppercase text-gray-400 flex items-center gap-2"><Globe size={12} /> Google Sheets (CSV)</p>
                                    </div>
                                    {['china', 'malaysia', 'bkk'].map(trip => (
                                        <div key={trip} className="space-y-1">
                                            <label className="font-bold uppercase text-[10px] flex items-center gap-1">{getFlag(trip)} {trip}</label>
                                            <input value={sheetLinks[trip]} onChange={(e) => saveSettings({...sheetLinks, [trip]: e.target.value})} placeholder="Paste link csv..." className="w-full p-2 border border-gray-200 text-xs font-mono rounded outline-none focus:border-black" />
                                        </div>
                                    ))}
                                </div>
                            </div>

                            <button onClick={() => setShowSettings(false)} className="w-full bg-black text-white py-3 font-black uppercase text-xs mt-6 rounded active:scale-95 transition-all shrink-0">Simpan Konfigurasi</button>
                        </div>
                    </div>
                )}

                {/* MODAL: VIEW DATABASE TRIP */}
                {showDataModal && (
                    <div className="fixed inset-0 bg-black/80 z-[60] flex items-center justify-center p-4 animate-in">
                        <div className="bg-white w-full max-w-md h-[80vh] flex flex-col p-4 border-2 border-black rounded shadow-2xl overflow-hidden">
                            <div className="flex justify-between items-center mb-4 border-b-2 border-black pb-3">
                                <h3 className="font-black text-lg uppercase flex items-center gap-2"><Eye size={20} /> Data {activeTrip}</h3>
                                <button onClick={() => setShowDataModal(false)} className="p-2 border border-black rounded hover:bg-black hover:text-white transition-all"><X size={18}/></button>
                            </div>
                            <div className="flex-1 overflow-auto custom-scrollbar border border-black rounded-sm">
                                <table className="w-full text-xs text-left">
                                    <thead className="bg-black text-white sticky top-0"><tr><th className="p-3">Nama</th><th className="p-3">Barang</th><th className="p-3 text-right">Harga</th></tr></thead>
                                    <tbody className="divide-y divide-gray-100">
                                        {activeCsvData.map((row, idx) => (
                                            <tr key={idx} className="hover:bg-yellow-50 cursor-pointer transition-colors" onClick={() => { setCustomerName(row.nama); setShowDataModal(false); }}>
                                                <td className="p-3 font-bold truncate max-w-[100px]">{row.nama}</td>
                                                <td className="p-3 truncate max-w-[150px]">{row.barang}</td>
                                                <td className="p-3 text-right font-mono">{formatR(pN(row.harga))}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                )}

                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
